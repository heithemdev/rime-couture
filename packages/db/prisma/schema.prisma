generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

/**
 * ============================================================================
 * ENUMS
 * ============================================================================
 */
enum Locale {
  EN
  FR
  AR
}

enum Currency {
  DZD
}

enum UserRole {
  CLIENT
  ADMIN
}

enum MediaKind {
  IMAGE
  VIDEO
  PDF
}

enum TagType {
  MATERIAL
  MOOD_SEASON
  PATTERN
  OCCASION
}

enum ProductStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  SHIPPING
  DELIVERED
}

enum PaymentProvider {
  CHARGILY
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  CANCELED
  REFUNDED
}

enum PaymentKind {
  CHARGE
  REFUND
  ADJUSTMENT
}

enum ShipmentProvider {
  YALIDINE
}

enum ShipmentStatus {
  CREATED
  LABEL_READY
  PICKED_UP
  IN_TRANSIT
  OUT_FOR_DELIVERY
  DELIVERED
  RETURNED
  CANCELED
  UNKNOWN
}

enum ReturnStatus {
  REQUESTED
  APPROVED
  REJECTED
  RECEIVED
  CLOSED
}

enum ReturnResolution {
  REFUND
  REPLACE
  REJECT
}

enum AnalyticsEventType {
  PAGE_VIEW
  VIEW_PRODUCT
  SEARCH
  START_CHECKOUT
  CART_ADD
  CART_REMOVE
  CART_ABANDONED
  PURCHASE
  ADD_TO_WISHLIST
  REMOVE_FROM_WISHLIST
  IMAGE_SEARCH
}

enum AiActor {
  PUBLIC
  CLIENT
  ADMIN
}

enum AiEndpoint {
  CHAT
  IMAGE_TAGS
}

/**
 * ============================================================================
 * USERS & AUTH
 * ============================================================================
 */
model User {
  id   String   @id @default(uuid()) @db.Uuid
  role UserRole @default(CLIENT)

  email        String  @unique
  phone        String?
  displayName  String?
  passwordHash String?

  preferredLocale Locale    @default(EN)
  emailVerifiedAt DateTime?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // --- Relations ---
  sessions        Session[] // Added for Auth
  wishlistItems   WishlistItem[]
  carts           Cart[]
  orders          Order[]
  reviews         Review[]
  reviewsHidden   Review[]         @relation("ReviewHiddenBy")
  returnDecisions ReturnRequest[]  @relation("ReturnDecisionBy")
  analyticsEvents AnalyticsEvent[]
  aiRequests      AiRequestLog[]
  productLikes    ProductLike[]

  @@index([role])
  @@index([deletedAt])
}

// Added for Secure Auth
model Session {
  id            String    @id @default(uuid()) @db.Uuid
  userId        String    @db.Uuid
  sessionIdHash String    @unique
  ip            String?
  userAgent     String?
  expiresAt     DateTime
  revokedAt     DateTime?
  createdAt     DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// Added for OTP / Email Verification
model VerificationToken {
  id         String    @id @default(uuid()) @db.Uuid
  email      String
  purpose    String // "SIGNUP" or "RESET"
  tokenHash  String
  expiresAt  DateTime
  consumedAt DateTime?
  createdAt  DateTime  @default(now())
  attempts   Int       @default(0)

  @@index([email, purpose])
}

/**
 * ============================================================================
 * CMS
 * ============================================================================
 */
model CmsPage {
  id          String   @id @default(uuid()) @db.Uuid
  slug        String   @unique
  isPublished Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  translations CmsPageTranslation[]
}

model CmsPageTranslation {
  id             String  @id @default(uuid()) @db.Uuid
  pageId         String  @db.Uuid
  locale         Locale
  title          String
  body           String
  seoTitle       String?
  seoDescription String?

  page CmsPage @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@unique([pageId, locale])
  @@index([locale])
}

/**
 * ============================================================================
 * TAXONOMY
 * ============================================================================
 */
model Category {
  id        String   @id @default(uuid()) @db.Uuid
  slug      String   @unique
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  translations CategoryTranslation[]
  products     Product[]

  @@index([isActive, sortOrder])
}

model CategoryTranslation {
  id          String  @id @default(uuid()) @db.Uuid
  categoryId  String  @db.Uuid
  locale      Locale
  name        String
  description String?

  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([categoryId, locale])
  @@index([locale])
}

model Size {
  id        String   @id @default(uuid()) @db.Uuid
  code      String   @unique
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  translations SizeTranslation[]
  variants     ProductVariant[]

  @@index([isActive, sortOrder])
}

model SizeTranslation {
  id     String @id @default(uuid()) @db.Uuid
  sizeId String @db.Uuid
  locale Locale
  label  String

  size Size @relation(fields: [sizeId], references: [id], onDelete: Cascade)

  @@unique([sizeId, locale])
  @@index([locale])
}

model Color {
  id        String   @id @default(uuid()) @db.Uuid
  code      String   @unique
  hex       String?
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  translations ColorTranslation[]
  variants     ProductVariant[]
  productMedia ProductMedia[]

  @@index([isActive, sortOrder])
}

model ColorTranslation {
  id      String @id @default(uuid()) @db.Uuid
  colorId String @db.Uuid
  locale  Locale
  label   String

  color Color @relation(fields: [colorId], references: [id], onDelete: Cascade)

  @@unique([colorId, locale])
  @@index([locale])
}

model Tag {
  id        String   @id @default(uuid()) @db.Uuid
  type      TagType
  slug      String
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  translations TagTranslation[]
  productLinks ProductTag[]

  @@unique([type, slug])
  @@index([type, isActive, sortOrder])
}

model TagTranslation {
  id     String @id @default(uuid()) @db.Uuid
  tagId  String @db.Uuid
  locale Locale
  label  String

  tag Tag @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([tagId, locale])
  @@index([locale])
}

/**
 * ============================================================================
 * MEDIA
 * ============================================================================
 */
model MediaAsset {
  id        String    @id @default(uuid()) @db.Uuid
  kind      MediaKind
  url       String
  mimeType  String?
  bytes     Int?
  width     Int?
  height    Int?
  durationS Int?
  provider  String?
  meta      Json?
  createdAt DateTime  @default(now())

  productLinks     ProductMedia[]
  shipmentLabelFor Shipment?

  @@index([kind])
}

/**
 * ============================================================================
 * PRODUCTS
 * ============================================================================
 */
model Product {
  id             String        @id @default(uuid()) @db.Uuid
  slug           String        @unique
  categoryId     String        @db.Uuid
  status         ProductStatus @default(DRAFT)
  currency       Currency      @default(DZD)
  basePriceMinor Int
  isCustomizable Boolean       @default(false)
  isMadeToOrder  Boolean       @default(false)
  leadTimeDays   Int?
  isFeatured     Boolean       @default(false)
  featuredOrder  Int?          @default(0)

  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  salesCount    Int   @default(0)
  wishlistCount Int   @default(0)
  reviewCount   Int   @default(0)
  avgRating     Float @default(0)
  likeCount     Int   @default(0)

  category        Category             @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  translations    ProductTranslation[]
  variants        ProductVariant[]
  media           ProductMedia[]
  tags            ProductTag[]
  orderItems      OrderItem[]
  reviews         Review[]
  wishlistItems   WishlistItem[]
  analyticsEvents AnalyticsEvent[]
  cartItems       CartItem[]
  likes           ProductLike[]

  @@index([categoryId, status, isActive])
  @@index([createdAt])
  @@index([deletedAt])
  @@index([isFeatured, featuredOrder])
}

model ProductTranslation {
  id             String  @id @default(uuid()) @db.Uuid
  productId      String  @db.Uuid
  locale         Locale
  name           String
  description    String
  seoTitle       String?
  seoDescription String?

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, locale])
  @@index([locale])
}

model ProductVariant {
  id         String   @id @default(uuid()) @db.Uuid
  productId  String   @db.Uuid
  variantKey String
  sku        String   @unique
  sizeId     String?  @db.Uuid
  colorId    String?  @db.Uuid
  priceMinor Int?
  stock      Int      @default(0)
  reserved   Int      @default(0)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  size    Size?   @relation(fields: [sizeId], references: [id], onDelete: Restrict)
  color   Color?  @relation(fields: [colorId], references: [id], onDelete: Restrict)

  orderItems OrderItem[]
  cartItems  CartItem[]

  @@unique([productId, variantKey])
  @@index([productId, isActive])
  @@index([sizeId])
  @@index([colorId])
}

model ProductMedia {
  id        String  @id @default(uuid()) @db.Uuid
  productId String  @db.Uuid
  mediaId   String  @db.Uuid
  colorId   String? @db.Uuid
  position  Int     @default(0)
  isThumb   Boolean @default(false)

  product Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  media   MediaAsset @relation(fields: [mediaId], references: [id], onDelete: Restrict)
  color   Color?     @relation(fields: [colorId], references: [id], onDelete: SetNull)

  @@unique([productId, mediaId])
  @@unique([productId, position])
  @@index([productId, position])
  @@index([isThumb])
  @@index([colorId])
}

model ProductTag {
  productId String @db.Uuid
  tagId     String @db.Uuid

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Restrict)

  @@id([productId, tagId])
  @@index([tagId, productId])
}

/**
 * ============================================================================
 * CARTS
 * ============================================================================
 */
model Cart {
  id          String    @id @default(uuid()) @db.Uuid
  userId      String?   @db.Uuid
  guestToken  String?   @unique
  currency    Currency  @default(DZD)
  locale      Locale    @default(EN)
  isActive    Boolean   @default(true)
  abandonedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user            User?            @relation(fields: [userId], references: [id], onDelete: SetNull)
  items           CartItem[]
  analyticsEvents AnalyticsEvent[]

  @@index([userId, isActive])
  @@index([guestToken])
}

model CartItem {
  id             String   @id @default(uuid()) @db.Uuid
  cartId         String   @db.Uuid
  productId      String   @db.Uuid
  variantId      String   @db.Uuid
  quantity       Int
  unitPriceMinor Int
  addedAt        DateTime @default(now())

  cart    Cart           @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product        @relation(fields: [productId], references: [id], onDelete: Restrict)
  variant ProductVariant @relation(fields: [variantId], references: [id], onDelete: Restrict)

  @@unique([cartId, variantId])
  @@index([cartId])
  @@index([variantId])
}

/**
 * ============================================================================
 * WISHLIST
 * ============================================================================
 */
model WishlistItem {
  userId    String   @db.Uuid
  productId String   @db.Uuid
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@id([userId, productId])
  @@index([createdAt])
}

/**
 * ============================================================================
 * ORDERS + PAYMENTS + SHIPPING
 * ============================================================================
 */
model Order {
  id             String        @id @default(uuid()) @db.Uuid
  orderNumber    String        @unique
  userId         String?       @db.Uuid
  checkoutLocale Locale        @default(EN)
  currency       Currency      @default(DZD)
  status         OrderStatus   @default(PENDING)
  paymentStatus  PaymentStatus @default(PENDING)

  subtotalMinor Int
  shippingMinor Int
  totalMinor    Int
  depositMinor  Int @default(0)

  customerName  String
  customerPhone String
  customerEmail String?
  addressLine1  String
  addressLine2  String?
  wilayaCode    Int
  wilayaName    String
  commune       String
  postalCode    String?
  customerNote  String?

  confirmedAt  DateTime?
  shippedAt    DateTime?
  deliveredAt  DateTime?
  canceledAt   DateTime?
  cancelReason String?

  exportedToSheetsAt DateTime?

  utmSource      String?
  utmMedium      String?
  utmCampaign    String?
  sessionId      String?
  cartIdSnapshot String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  user            User?                @relation(fields: [userId], references: [id], onDelete: SetNull)
  items           OrderItem[]
  payments        PaymentTransaction[]
  shipment        Shipment?
  returns         ReturnRequest[]
  analyticsEvents AnalyticsEvent[]

  @@index([userId, createdAt])
  @@index([status, createdAt])
  @@index([paymentStatus, createdAt])
  @@index([deletedAt])
  @@index([sessionId, createdAt])
}

model OrderItem {
  id              String   @id @default(uuid()) @db.Uuid
  orderId         String   @db.Uuid
  productId       String?  @db.Uuid
  variantId       String?  @db.Uuid
  quantity        Int
  unitPriceMinor  Int
  lineTotalMinor  Int
  productName     String
  productSlug     String
  productImageUrl String?
  sizeLabel       String?
  colorLabel      String?
  createdAt       DateTime @default(now())

  order       Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product     Product?        @relation(fields: [productId], references: [id], onDelete: SetNull)
  variant     ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  review      Review?
  returnItems ReturnItem[]

  @@index([orderId])
  @@index([productId, createdAt])
}

model PaymentTransaction {
  id                 String          @id @default(uuid()) @db.Uuid
  orderId            String          @db.Uuid
  provider           PaymentProvider @default(CHARGILY)
  status             PaymentStatus   @default(PENDING)
  kind               PaymentKind     @default(CHARGE)
  amountMinor        Int
  currency           Currency        @default(DZD)
  providerCheckoutId String?
  providerPaymentId  String?
  paymentMethod      String?
  parentPaymentId    String?

  payload     Json?
  processedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId, createdAt])
  @@index([provider, providerCheckoutId])
  @@index([provider, providerPaymentId])
  @@index([status, createdAt])
  @@index([kind, createdAt])
}

model Shipment {
  id                 String           @id @default(uuid()) @db.Uuid
  orderId            String           @unique @db.Uuid
  provider           ShipmentProvider @default(YALIDINE)
  status             ShipmentStatus   @default(CREATED)
  providerShipmentId String?
  trackingCode       String?          @unique
  labelPdfUrl        String?
  labelPdfAssetId    String?          @unique @db.Uuid
  rawCreatePayload   Json?
  rawLatestPayload   Json?
  syncedAt           DateTime?
  nextSyncAt         DateTime?
  lastWebhookAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  order         Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  labelPdfAsset MediaAsset?     @relation(fields: [labelPdfAssetId], references: [id], onDelete: SetNull)
  events        ShipmentEvent[]

  @@index([status, createdAt])
}

model ShipmentEvent {
  id             String         @id @default(uuid()) @db.Uuid
  shipmentId     String         @db.Uuid
  status         ShipmentStatus @default(UNKNOWN)
  externalStatus String?
  description    String?
  location       String?
  occurredAt     DateTime
  rawPayload     Json?

  shipment Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  @@index([shipmentId, occurredAt])
  @@index([status, occurredAt])
}

/**
 * ============================================================================
 * REVIEWS
 * ============================================================================
 */
model Review {
  id                String  @id @default(uuid()) @db.Uuid
  productId         String  @db.Uuid
  orderItemId       String? @unique @db.Uuid
  userId            String? @db.Uuid
  guestEmail        String?
  guestPhone        String?
  verificationToken String?
  fingerprint       String? // Browser fingerprint to prevent spam

  reviewerName String  @default("Anonymous")
  rating       Int
  title        String?
  comment      String?

  isHidden       Boolean   @default(false)
  hiddenReason   String?
  hiddenByUserId String?   @db.Uuid
  hiddenAt       DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product      Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  orderItem    OrderItem? @relation(fields: [orderItemId], references: [id], onDelete: Restrict)
  user         User?      @relation(fields: [userId], references: [id], onDelete: SetNull)
  hiddenByUser User?      @relation("ReviewHiddenBy", fields: [hiddenByUserId], references: [id], onDelete: SetNull)

  @@unique([productId, fingerprint])
  @@index([productId, createdAt])
  @@index([userId, createdAt])
  @@index([isHidden, createdAt])
  @@index([fingerprint])
}

/**
 * ============================================================================
 * PRODUCT LIKES
 * ============================================================================
 */
model ProductLike {
  id          String   @id @default(uuid()) @db.Uuid
  productId   String   @db.Uuid
  userId      String?  @db.Uuid
  fingerprint String // Browser fingerprint for guests
  createdAt   DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  user    User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([productId, fingerprint])
  @@index([productId])
  @@index([userId])
}

/**
 * ============================================================================
 * RETURNS
 * ============================================================================
 */
model ReturnRequest {
  id              String            @id @default(uuid()) @db.Uuid
  orderId         String            @db.Uuid
  status          ReturnStatus      @default(REQUESTED)
  resolution      ReturnResolution?
  reason          String?
  notes           String?
  decidedByUserId String?           @db.Uuid
  resolvedAt      DateTime?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  order     Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  decidedBy User?        @relation("ReturnDecisionBy", fields: [decidedByUserId], references: [id], onDelete: SetNull)
  items     ReturnItem[]

  @@index([status, createdAt])
  @@index([orderId])
}

model ReturnItem {
  id                String       @id @default(uuid()) @db.Uuid
  returnRequestId   String       @db.Uuid
  orderItemId       String       @db.Uuid
  quantity          Int
  refundAmountMinor Int?
  status            ReturnStatus @default(REQUESTED)

  returnRequest ReturnRequest @relation(fields: [returnRequestId], references: [id], onDelete: Cascade)
  orderItem     OrderItem     @relation(fields: [orderItemId], references: [id], onDelete: Restrict)

  @@unique([returnRequestId, orderItemId])
  @@index([orderItemId])
}

/**
 * ============================================================================
 * ANALYTICS
 * ============================================================================
 */
model AnalyticsEvent {
  id          String             @id @default(uuid()) @db.Uuid
  type        AnalyticsEventType
  occurredAt  DateTime           @default(now())
  sessionId   String?
  userId      String?            @db.Uuid
  ipHash      String?
  userAgent   String?
  path        String?
  referrer    String?
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  productId   String?            @db.Uuid
  orderId     String?            @db.Uuid
  cartId      String?            @db.Uuid
  meta        Json?

  user    User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  product Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
  order   Order?   @relation(fields: [orderId], references: [id], onDelete: SetNull)
  cart    Cart?    @relation(fields: [cartId], references: [id], onDelete: SetNull)

  @@index([type, occurredAt])
  @@index([productId, occurredAt])
  @@index([orderId, occurredAt])
  @@index([cartId, occurredAt])
  @@index([userId, occurredAt])
}

/**
 * ============================================================================
 * AI
 * ============================================================================
 */
model AiCacheEntry {
  id        String     @id @default(uuid()) @db.Uuid
  endpoint  AiEndpoint
  actor     AiActor
  locale    Locale
  keyHash   String
  text      String?
  json      Json?
  expiresAt DateTime?
  createdAt DateTime   @default(now())

  @@unique([endpoint, actor, locale, keyHash])
  @@index([expiresAt])
}

model AiRequestLog {
  id             String     @id @default(uuid()) @db.Uuid
  endpoint       AiEndpoint
  actor          AiActor
  userId         String?    @db.Uuid
  ipHash         String?
  locale         Locale
  model          String?
  promptTokens   Int?
  responseTokens Int?
  latencyMs      Int?
  success        Boolean    @default(true)
  refused        Boolean    @default(false)
  errorCode      String?
  request        Json?
  response       Json?
  createdAt      DateTime   @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([actor, createdAt])
  @@index([endpoint, createdAt])
  @@index([userId, createdAt])
  @@index([ipHash, createdAt])
}

/**
 * ============================================================================
 * WEBHOOK / EMAIL LOGS
 * ============================================================================
 */
model WebhookLog {
  id          String    @id @default(uuid()) @db.Uuid
  source      String
  eventType   String?
  externalId  String?
  status      String?
  error       String?
  payload     Json?
  receivedAt  DateTime  @default(now())
  processedAt DateTime?

  @@index([source, receivedAt])
  @@index([externalId])
}

model EmailLog {
  id       String   @id @default(uuid()) @db.Uuid
  toEmail  String
  template String
  subject  String?
  status   String?
  error    String?
  payload  Json?
  sentAt   DateTime @default(now())

  @@index([toEmail, sentAt])
}
